---
title: "Issue Man"
date: 2020-03-07T11:06:13+08:00
tags: ["none",]
draft: true 

---

# issue-man

一个依赖 GitHub Issue 进行内容管理的工具。

# 分支

下面的一个 `文档` 一般都是指的：`index.md` 或 `index.html` 文件所在其目录下的所有文件（一般都是 .svg 之类的相关的图片文件），`_index.md` 和 `_index.html` 不在此列。

### 分支：

- `master`：定时（有权限的话也可以用 Webhook） pull istio.io 的 master 分支。

- `target`：最初基于 master，后续根据翻译进度不断变化。

- `work`：`创建` 或 `更新` 某个 issue 时，将当时 master 对应文档复制到该分支，等 issue 关闭后，用该分支的内容覆盖 `target` 分支对应的内容（视作完成一次更新）。

- `cache`：存放需要等待（合并后才能创建 issue）的文档路径，但不存放内容（待前一个 issue 合并后，再比较内容，创建 issue）。

在最初，将 `master` 和 `zh-trans` 分支内容视为已完全同步。以前遗留的未同步的内容需要一次完整的校对工作，或者为每一个文档都创建一个 issue 进行校对，以避免造成混乱和重复检查的情况。

# 流程

### 新增/修改

每次 master 分支有变化后，对本次 commit 的涉及的文档进行比较，获取差异内容。对每一个有差异的文档进行以下处理：

查看该文档是否已经在任务队列中：
    如果不在，则创建 issue、将 issue 信息，差异内容等缓存至任务队列。
    如果在，则需要判断任务状态：
        如果处于 `阈值`（如 `/pushed`）状态 `之前`，则获取任务信息，根据其中的 issue 信息，更新 issue 的内容，并用最新的差异内容覆盖缓存内容。
        如果处于 `阈值`（如 `/pushed`）状态 `以及之后`，则将该文档放入到 `pending` 队列。

领取任务后，在 issue 到达 `阈值` 状态前，需要注意 issue 的内容是否有变化，理论上，它是有可能变化的。

// TO-DO 如何处理更新请求达到 GitHub 之前，issue 到达了 `阈值` 状态的情况。

### 查询/删除

通过 Webhook（没权限也可以通过定时查询）获取任务队列中 issue 的状态。

这里主要关注 issue 的关闭，issue 关闭，则视为文档以完成更新（通过了人工 review），并做如下处理：

从任务队列提取该任务相关的信息。

根据信息，将 `work` 分支对应的内容复制到 `target` 分支。

检测 `cache` 分支是否有等待的任务，如果有，则对该分支重复完整流程。

# 初始化

token 必需在程序启动时提供，也不提供配置文件的支持，更不会私自存储、泄露 token。只有在请求 GitHub API 时才会用到。（对于实在不想输入的同学，可以自己写个脚本）
源仓库地址（如果是私有库，则需要 token）
目标仓库地址（需要 token）
初始化分支（配置分支名）

# 操作

### GitHub

GitHub API：更新内容、获取状态、创建 issue、打标签。

GitHub Webhook：更新内容、获取状态。

> 通过 Webhook `更新内容、获取状态` 是一种更优雅的方式，但这需要足够的权限。

文档对比。

数据持久化。

现场恢复。

### 逻辑处理

解析需要的数据：如判断状态、判断身份等

# issue 处理（TODO）

GitHub Webhook

筛选出 `指令`。

判断状态，操作（分配/报错）。

# 其它

用 GraphQL v4

获取某次 commit 涉及的文件

任务队列，缓存队列

格式化功能，如中英文隔一个空格
