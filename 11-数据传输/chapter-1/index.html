<head>
  <meta charset="utf-8">
  <title>QUIC</title>

  <meta name="generator" content="Hugo 0.57.2" />

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <!-- ** Plugins Needed for the Project ** -->
  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://static.sguan.top/plugins/bootstrap/bootstrap.min.css">
  <!-- themefy-icon -->
  <link rel="stylesheet" href="https://static.sguan.top/plugins/themify-icons/themify-icons.css">
  <!-- highlight -->
  <link rel="stylesheet" href="https://static.sguan.top/plugins/highlight/hybrid.css">
  <!-- fonts -->



  <style>
  :root{
    --primary-color:#333;
    --secondary-color:#f9f9f9;
    --text-color:#636363;
    --text-color-dark:#242738;
    --white-color:#ffffff;
  }  
  </style>

  <!-- Main Stylesheet -->
  

  <link rel="stylesheet" href="https://static.sguan.top/css/style.min.css" integrity="" media="screen">

  <!-- jquiry -->
  <script src="https://static.sguan.top/plugins/jquery/jquery-1.12.4.js"></script>

  <!-- jquary ui -->
  <script src="https://static.sguan.top/plugins/jquery/jquery-ui.js"></script>

  <!--Favicon-->

  <link rel="icon" href="https://static.sguan.top/favicon.png" type="image/x-icon">

</head>


<!-- navigation -->
<header class="shadow-bottom sticky-top bg-white">
  <div class="container">
    <nav class="navbar navbar-expand-lg navbar-light">
  <a class="navbar-brand" href="https://www.1996.live/">TheOrigin</a>
  <button class="navbar-toggler border-0" type="button" data-toggle="collapse" data-target="#navigation"
    aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse text-center" id="navigation">
    <ul class="navbar-nav ml-auto">
      <li class="nav-item">
        <a class="nav-link text-dark" href="https://www.1996.live/">主页</a>
      </li>
      
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle text-dark" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
          aria-expanded="false">
          分类
        </a>
        <div class="dropdown-menu" >
          
          <a class="dropdown-item" href="/00-windows">Windows</a>
          
          <a class="dropdown-item" href="/01-linux">Linux</a>
          
          <a class="dropdown-item" href="/02-架构">架构</a>
          
          <a class="dropdown-item" href="/03-docker">Docker</a>
          
          <a class="dropdown-item" href="/04-k8s">K8S</a>
          
          <a class="dropdown-item" href="/05-istio">Istio</a>
          
          <a class="dropdown-item" href="/10-git">Git</a>
          
          <a class="dropdown-item" href="/11-%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93">数据传输</a>
          
          <a class="dropdown-item" href="/12-%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8">数据存储</a>
          
          <a class="dropdown-item" href="/13-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%92%8C%E7%AE%97%E6%B3%95">数据结构和算法</a>
          
          <a class="dropdown-item" href="/20-golang">Golang</a>
          
          <a class="dropdown-item" href="/21-python">Python</a>
          
          <a class="dropdown-item" href="/22-java">Java</a>
          
          <a class="dropdown-item" href="/30-react">React</a>
          
          <a class="dropdown-item" href="/31-vue">Vue</a>
          
        </div>
      </li>
      
      
      
      <li class="nav-item">
          <a class="nav-link text-dark" href="/faq">关于</a>
      </li>
      
      
    </ul>
    
    <ul class="list-inline text-center mb-0">
      
    </ul>
  </div>
</nav>
  </div>
</header>
<!-- /navigation -->


<section class="single pt-5 bg-gray">
  <div class="container">
    <div class="row">
      <div class="col-lg-3">
        <div class="p-4 bg-white sticky-top top-100">
            
            <nav class="sidebar-menu">
              <ul class="list-styled">
            <li class=""><a href="/00-windows">Windows</a>
              <ul class="">
            <li class=""><a href="/00-windows/1-windows">快速装机手册</a>
            </li>
            <li class=""><a href="/00-windows/2-tips">一些小技巧</a>
            </li></ul>
              
            </li>
            <li class=""><a href="/01-linux">Linux</a>
              <ul class="">
            <li class=""><a href="/01-linux/1-装机">装机</a>
            </li>
            <li class=""><a href="/01-linux/2-科学上网">科学上网技术是第一生产力</a>
            </li></ul>
              
            </li>
            <li class=""><a href="/02-架构">架构</a>
              <ul class="">
            <li class=""><a href="/02-架构/chapter-1">QUIC</a>
            </li></ul>
              
            </li>
            <li class=""><a href="/03-docker">Docker</a>
              <ul class="">
            <li class=""><a href="/03-docker/chapter-1">QUIC</a>
            </li></ul>
              
            </li>
            <li class=""><a href="/04-k8s">K8S</a>
              <ul class="">
            <li class=""><a href="/04-k8s/chapter-1">QUIC</a>
            </li></ul>
              
            </li>
            <li class=""><a href="/05-istio">Istio</a>
              <ul class="">
            <li class=""><a href="/05-istio/chapter-1">QUIC</a>
            </li></ul>
              
            </li>
            <li class=""><a href="/10-git">Git</a>
              <ul class="">
            <li class=""><a href="/10-git/chapter-1">QUIC</a>
            </li></ul>
              
            </li>
            <li class="parent d-block "><a href="/11-%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93/">数据传输</a>
              <ul class="sub-menu">
            <li class=" active "><a href="/11-%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93/chapter-1/">QUIC</a>
            </li></ul>
              
            </li>
            <li class=""><a href="/12-%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/">数据存储</a>
              <ul class="">
            <li class=""><a href="/12-%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/chapter-1/">QUIC</a>
            </li></ul>
              
            </li>
            <li class=""><a href="/13-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%92%8C%E7%AE%97%E6%B3%95/">数据结构和算法</a>
              <ul class="">
            <li class=""><a href="/13-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%92%8C%E7%AE%97%E6%B3%95/chapter-1/">QUIC</a>
            </li></ul>
              
            </li>
            <li class=""><a href="/20-golang/">Golang</a>
              <ul class="">
            <li class=""><a href="/20-golang/chapter-1/">QUIC</a>
            </li></ul>
              
            </li>
            <li class=""><a href="/21-python/">Python</a>
              <ul class="">
            <li class=""><a href="/21-python/chapter-1/">QUIC</a>
            </li></ul>
              
            </li>
            <li class=""><a href="/22-java/">Java</a>
              <ul class="">
            <li class=""><a href="/22-java/chapter-1/">QUIC</a>
            </li></ul>
              
            </li>
            <li class=""><a href="/30-react/">React</a>
              <ul class="">
            <li class=""><a href="/30-react/chapter-1/">QUIC</a>
            </li></ul>
              
            </li>
            <li class=""><a href="/31-vue/">Vue</a>
              <ul class="">
            <li class=""><a href="/31-vue/chapter-1/">QUIC</a>
            </li></ul>
              
            </li>
            <li class=""><a href="/faq/">有什么想要问我吗？</a>
            </li></ul>
            </nav>

            
        </div>
      </div>
      <div class="col-lg-9">
        <div class="p-5 bg-white">
            <h2>QUIC</h2>
            

<h1 id="前言">前言</h1>

<ul>
<li>emmm~,今天是9102年儿童节，都9102年了，你的网站还是万年HTTP吗，Chrome已经看你不爽很久了，得益于Let&rsquo;s Encrypt，现在申请TLS证书变得异常简单。</li>
</ul>

<p><img src="https://cdn.sguan.top/markdown/20190601/4FHJ3R47NG9d.png?imageslim" alt="mark" /></p>

<ul>
<li>本文将分享我是如何开启整站HTTPS和QUIC，网上关于QUIC的介绍文章挺多的，既然你在看这篇文章，相信是对QUIC有一定了解的，本文不在做重复介绍相关概念。</li>
<li>网上的很多文章教程略微复杂，本文将带领你从0开始部署，大学生都学得会。</li>
<li>本文使用的浏览器是Chrome73，协议是QUIC43。最终效果如下。</li>
</ul>

<p><img src="https://cdn.sguan.top/markdown/20190405/VVUpvJnSzyJN.png?imageslim" alt="mark" /></p>

<h1 id="前置条件">前置条件</h1>

<p>虽然说是从0开始，但是你还是得准备一些东西：</p>

<ul>
<li>有一定的Linux基础，至少要能跟着做吧~</li>
<li>拥有或注册一个自己的域名。</li>
<li>拥有一台服务器，需要将域名解析到该服务器。</li>
<li>安装 <code>Docker&amp;Docker-compose</code>环境，这会使整个过程变得非常简单，花几分钟安装Docker是值得的，如果不会的同学，请参考前面的教程，安装Docker。</li>
</ul>

<h1 id="dns解析">DNS解析</h1>

<ul>
<li>如果你知道如何配置DNS，可以跳过</li>
<li>主机记录@，记录类型A，记录值你的服务器公网IP地址。</li>
<li>主机记录*，记录类型CNAME，记录值你域名(末尾有个.)</li>
<li>大概就是下面这个样子。
<img src="https://cdn.sguan.top/markdown/20190405/lMV1emK21F1v.png?imageslim" alt="mark" /></li>
</ul>

<h1 id="注意">注意</h1>

<ul>
<li>这里我默认你已经安装好了<code>Docker</code>以及<code>Docker-compose</code>，即将会使用到该工具，如果没有正确安装，请看安装这两个工具的教程。</li>
<li>后续操作我是在CentOS7下面进行的，请确保你的账号有足够的权限(root)</li>
</ul>

<h1 id="准备配置文件">准备配置文件</h1>

<ul>
<li>mkdir -p /containers/caddy</li>
<li>cd /containers/caddy</li>

<li><p>vi docker-compose.yml</p>

<pre><code>version: '2'
services:
caddy-server:
image: abiosoft/caddy:latest
container_name: caddy-server
ports:
  - &quot;443:443/udp&quot;
  - &quot;443:443&quot;
  - &quot;80:80&quot;
volumes:
  - &quot;/containers/caddy/Caddyfile:/etc/Caddyfile&quot;
  - &quot;/containers/caddy/.caddy:/root/.caddy&quot;
  - &quot;/containers/caddy/log:/root/log&quot;
  - &quot;/containers/caddy/www:/www&quot;
restart: always
entrypoint :  &quot;tail -f /dev/null&quot;
</code></pre></li>

<li><p>保存退出</p></li>

<li><p>vi ./www/index.html</p>

<pre><code>&lt;h1&gt;Hello World&lt;/h1&gt;
</code></pre></li>

<li><p>保存退出</p></li>

<li><p>vi Caddyfile</p>

<pre><code># 请替换为自己的域名
https://www.1996.live {
gzip
# 请替换为自己的邮箱
tls imqksl@gmail.com
root /www
log /root/log/log.log
errors /root/log/error.log 
}
</code></pre></li>

<li><p>保存退出</p></li>

<li><p>docker-compose up -d</p></li>

<li><p>docker ps</p></li>
</ul>

<blockquote>
<p>如果没有意外，你这个时候应该是跟我的截图类似，注意 STATUS   Up * Seconds应该就是正常启动了。</p>
</blockquote>

<p><img src="https://cdn.sguan.top/markdown/20190405/YG5WnKC8KSIj.png?imageslim" alt="mark" /></p>

<ul>
<li><p>docker exec -i -t caddy-server sh
&gt; 执行这条命令后，我们会进入该容器内容，可以通过命令行左侧路径分辨出来。</p></li>

<li><p>caddy -quic -conf /etc/Caddyfile
&gt; 执行这条命令后，Caddy会询问是否同意相关协议。怎么选，同学你自己心里有数吧。</p></li>
</ul>

<p><img src="https://cdn.sguan.top/markdown/20190405/pCCiQdiQ2m6S.png?imageslim" alt="mark" /></p>

<blockquote>
<p>然后Caddy会自动去申请HTTPS证书，免费的，一般两分钟以内完成。 这里可能会让你再输入一次邮箱地址。完成后，大概就是这个样子。</p>
</blockquote>

<p><img src="https://cdn.sguan.top/markdown/20190405/y4fAuylGOUny.png?imageslim" alt="mark" /></p>

<blockquote>
<p>通过域名访问即可，注意使用https://</p>

<p>请关闭科学上网，代理工具等，因为他可能会将UDP数据代理至TCP，而QUIC基于UDP，就会导致QUIC连接建立失败，此时连接使用HTTP/2 以及TLS1.3证书。</p>

<p>请确保服务器防火墙允许80，443端口流量通过</p>
</blockquote>

<p><img src="https://cdn.sguan.top/markdown/20190405/S5YKdem7grcr.png?imageslim" alt="mark" /></p>

<h1 id="善后处理">善后处理</h1>

<ul>
<li>ctrl+c</li>
<li>exit</li>
<li>docker-compose down</li>

<li><p>vi docker-compose.yml</p>

<pre><code>version: '2'
services:
caddy-server:
image: abiosoft/caddy:latest
container_name: caddy-server
ports:
  - &quot;443:443/udp&quot;
  - &quot;443:443&quot;
  - &quot;80:80&quot;
volumes:
  - &quot;/containers/caddy/Caddyfile:/etc/Caddyfile&quot;
  - &quot;/containers/caddy/.caddy:/root/.caddy&quot;
  - &quot;/containers/caddy/log:/root/log&quot;
  - &quot;/containers/caddy/www:/www&quot;
restart: always
entrypoint :  &quot;caddy -quic -conf /etc/Caddyfile&quot;  # 整个文件只修改这里
</code></pre></li>
</ul>

<blockquote>
<p>这个文件只修改了最后一行的内容</p>
</blockquote>

<ul>
<li>docker-compose up -d</li>
<li>systemctl enable docker</li>
</ul>

<blockquote>
<p>善后的步骤挺多余的，由于初次运行Caddy需要同意用户协议，作者不知道该怎么让docker-compose的容器接受键盘输入，出此下策，希望有懂的朋友指点一下。</p>

<p>自此，如果没有意外的话，以后该服务器都会自动运行。</p>

<p>静态文件根据自己的需求替换即可</p>

<p>Caddy也有反向代理等功能，可以轻松实现整站QUIC，后面会讲到。</p>

<p>如果你已经完全安装本文操作，但是依然不能建立QUIC连接，一个可能的原因是ISP阻断了UDP数据，可以让其它地区的朋友帮忙测试一下。</p>
</blockquote>

<h1 id="强制https">强制HTTPS</h1>

<p>完成前面的操作后，虽然我们可以通过输入<code>https://yourdomain</code>实现HTTPS连接，但是如果输入<code>http://yourdomain</code>浏览器与服务器的连接还是HTTP连接。这里我们通过配置Caddyfile的内容就可以实现强制HTTPS，原理很简单，将HTTP重定向至HTTPS即可。</p>

<ul>
<li><p>vi Caddyfile</p>

<pre><code>http://www.1996.live  http://1996.live  https://1996.live{
redir https://www.1996.live{url}
}
# 请替换为自己的域名
https://www.1996.live {
gzip
# 请替换为自己的邮箱
tls imqksl@gmail.com
root /www
log /root/log/log.log
errors /root/log/error.log 
}
</code></pre></li>

<li><p>docker-compose down</p></li>

<li><p>docker-compose up -d</p></li>
</ul>

<h1 id="整站https">整站HTTPS</h1>

<ul>
<li>我们的网站可能不只一个Web服务，比如我除了<code>www.1996.live</code>的主页以外，在另一台服务器上还跑了一个<code>harbor</code>镜像仓库，域名已经指向当前服务器的IP地址，镜像仓库只能通过IP+端口访问。</li>
</ul>

<p><img src="https://cdn.sguan.top/markdown/20190601/SLOXoAqQmOc8.png?imageslim" alt="mark" /></p>

<ul>
<li>通过反向代理功能，可以轻松的将域名指向服务器上的另一个或者另一个服务器上的应用，Apache，Caddy，Nginx，同时因为是通过Caddy访问的，连接依然是HTTPS和QUIC的，（Caddy与应用之间应该是普通的HTTP）。</li>
<li>比如这里我打算给我的镜像仓库分配域名<code>hub.1996.live</code>，修改Caddyfile即可。</li>

<li><p>vi Caddyfile</p>

<pre><code>http://www.1996.live  http://1996.live  https://1996.live{
redir https://www.1996.live{url}
}
# 请替换为自己的域名
https://www.1996.live {
gzip
# 请替换为自己的邮箱
tls imqksl@gmail.com
root /www
log /root/log/log.log
errors /root/log/error.log 
}

# 添加下面的这部分内容即可
http://hub.1996.live{
redir https://hub.1996.live{url}
}
https://hub.1996.live {
gzip
tls imqksl@gmail.com
# 填写另一个应用所在服务器的IP地址和端口即可
# 一般填局域网IP地址，速度更快，更安全。
proxy / http://157.230.159.156 {
header_upstream Host {host}
header_upstream X-Real-IP {remote}
header_upstream X-Forwarded-For {remote}
header_upstream X-Forwarded-Proto {scheme}
}
log /root/log/log.log
errors /root/log/error.log 
}
</code></pre></li>

<li><p>docker-compose down</p></li>

<li><p>docker-compose up -d</p></li>
</ul>

<p><img src="https://cdn.sguan.top/markdown/20190405/a8KVjpvxeMTB.png?imageslim" alt="mark" /></p>

<h1 id="最后">最后</h1>

<p>昨晚与<code>Go语言中文网站长</code><a href="https://studygolang.com/user/polaris">polaris</a>语音聊了一个多小时，认识到自己真的是太菜了，需要学习的东西还有很多。最后聊到了写博客，站长建议我写博客，看了看自己Go方面的笔记实在是没啥营养，感觉自己这篇部署HTTPS&amp;QUIC的文章可能比较实用，大家搭建博客的时候可以用到，所以将它分享出来。</p>

<p>写到这里发现很多自己了解的东西，想把它表达清楚确实是还需要去理解一些深层次的东西以及锻炼口头表达能力才行。这两篇文章有很多地方表达不够清除、准确、严谨，后续会继续完善，修改的，欢迎各位看官一起交流，指点。</p>

<blockquote>
<h3 id="参考链接">参考链接</h3>
</blockquote>

<p><a href="https://www.yinchengli.com/2018/06/10/quic/">怎么把网站升级到QUIC以及QUIC特性分析</a></p>

<p><a href="https://halfrost.com/quic_start/#1">本站开始支持 QUIC</a></p>

<p><a href="https://www.jianshu.com/p/15fc32760993">Caddy Web服务器QUIC部署</a></p>

            <p class="post-meta border-bottom pb-3 mb-0">Updated on 09 Apr 2019</p><nav class="pagination mt-3"><a class="nav nav-prev" href="/11-%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93/" title="数据传输"><i class="ti-arrow-left mr-2"></i>数据传输</a>
            <a class="nav nav-next" href="/12-%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/" title="数据存储">数据存储<i class="ti-arrow-right ml-2"></i></a>
            </nav></div>
      </div>
    </div>
  </div>
</section>


<!-- footer -->
<footer class="section bg-gray pb-0">
  <div class="container">
    <div class="row">
      <div class="col-md-8 text-md-left text-center">
        <p>由 Hugo 强力驱动  •  基于 Dot 主题修改</p> 
      </div>
      <div class="col-md-4 text-md-right text-center">
        <ul class="list-inline mb-3">
          
          <li class="list-inline-item"><a class="text-color d-inline-block p-2" href="https://github.com/the-origin"><i class="ti-github"></i></a></li>
          
        </ul>
      </div>
    </div>
  </div>
</footer>
<!-- /footer -->

<!-- Bootstrap JS -->
<script src="https://static.sguan.top/plugins/bootstrap/bootstrap.min.js"></script>
<!-- highlight -->
<script src="https://static.sguan.top/plugins/highlight/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<!-- Main Script -->


<script src="https://static.sguan.top/js/script.min.js"></script>